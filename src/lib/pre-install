#! /usr/bin/env php
<?php

$LIB_DIR = dirname(__FILE__);
$APP_DIR = dirname($LIB_DIR);
$CONFIG_FILE = '../conf/config.ini';
$APACHE_CONFIG_FILE = '../conf/httpd.conf';

// work from lib directory
chdir($LIB_DIR);
// set default timezone
date_default_timezone_set('UTC');


// setup configuration defaults and help

$DEFAULTS = array(
	'APP_DIR' => $APP_DIR,
	'DATA_DIR' => str_replace('/apps/','/data/',
			str_replace('src', 'data', $APP_DIR)),
	'SCRIPT_DIR' => str_replace('/apps/','/scripts/',
			str_replace('src', 'scripts', $APP_DIR)),
	'MOUNT_PATH' => '/usdesign',
	'DB_DRIVER' => 'pgsql',
	'DB_HOST' => '',
	'DB_NAME' => '',
	'DB_SCHEMA' => 'us_design',
	'DB_READ_USER' => '',
	'DB_READ_PASSWORD' => ''
);

$HELP_TEXT = array(
	'APP_DIR' => 'Absolute path to application root directory',
	'DATA_DIR' => 'Absolute path to application data directory',
	'SCRIPT_DIR' => 'Absolute path to application script directory',
	'MOUNT_PATH' => 'Url path to application',
	'DB_DRIVER' => 'Database driver',
	'DB_HOST' => 'Database host',
	'DB_NAME' => 'Database name',
	'DB_SCHEMA' => 'Database schema',
	'DB_READ_USER' => 'Database reader user',
	'DB_READ_PASSWORD' => 'Database reader password'
);


// interactively configure

include 'configure.php';


// output apache configuration
// TODO - modify/add rules as appropriate once service layer/UI implemented.
file_put_contents($APACHE_CONFIG_FILE, '
	# auto generated by ' . __FILE__ . ' at ' . date('r') . '
	Alias ' . $CONFIG['MOUNT_PATH'] . ' ' . $CONFIG['APP_DIR'] . '

	RewriteRule ' .
			'^' . $CONFIG['MOUNT_PATH'] . '/service/([^/]+)/([^/]+)/([^/]+)$ ' .
			$CONFIG['MOUNT_PATH'] . '/service.php?x=$1&y=$2&c=$3 [L,PT]

	RewriteRule ' .
			'^' . $CONFIG['MOUNT_PATH'] . '/service/([^/]+)/([^/]+)/?$ ' .
			$CONFIG['MOUNT_PATH'] . '/service.php?x=$1&y=$2 [L,PT]

	<Location ' . $CONFIG['MOUNT_PATH'] . '>
		Order Allow,Deny
		Allow from all
	</Location>
');
?>
